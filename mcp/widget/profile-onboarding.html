<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      :root {
        color-scheme: light dark;
        --bg: #0f172a;
        --panel: #111827;
        --border: #1f2937;
        --muted: #9ca3af;
        --accent: #6ee7b7;
        --accent-strong: #34d399;
        --text: #e5e7eb;
      }

      body {
        margin: 0;
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: var(--bg);
        color: var(--text);
      }

      .panel {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 16px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.35);
      }

      h1 {
        font-size: 18px;
        margin: 0 0 8px;
      }

      .subtitle {
        color: var(--muted);
        font-size: 13px;
        margin-bottom: 16px;
      }

      /* Auth Styles */
      .auth-container { display: flex; flex-direction: column; gap: 12px; padding: 10px 0; }
      .auth-input { padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: rgba(255,255,255,0.05); color: var(--text); font-size: 14px; box-sizing: border-box; width: 100%; }
      .auth-input:focus { outline: 2px solid var(--accent); border-color: transparent; }
      .auth-btn { background: var(--accent); color: #0b1223; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; font-size: 14px; width: 100%; }
      .auth-btn:hover { opacity: 0.9; }
      .auth-btn.secondary { background: transparent; border: 1px solid var(--accent); color: var(--accent); }
      .google-btn { background: white; color: #333; display:flex; justify-content:center; align-items:center; gap:8px; }
      .link-btn { background: none; border: none; color: var(--muted); cursor: pointer; text-decoration: underline; font-size: 12px; }
      .link-btn:hover { color: var(--accent); }
      .error-msg { color: #ef4444; font-size: 13px; margin-top: 4px; text-align: center; min-height: 20px; }
      .divider { text-align: center; font-size: 12px; color: var(--muted); margin: 4px 0; }

      .status-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
        font-size: 13px;
      }

      .pill {
        padding: 4px 10px;
        background: rgba(110, 231, 183, 0.08);
        color: var(--accent);
        border-radius: 999px;
        border: 1px solid rgba(110, 231, 183, 0.35);
        font-weight: 600;
        font-size: 12px;
      }

      .sections {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 12px;
      }

      .section-card {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        background: #0b1223;
        cursor: pointer;
        transition: border-color 0.2s;
      }
      
      .section-card:hover {
        border-color: rgba(110, 231, 183, 0.4);
      }

      .section-card[data-active="true"] {
        border-color: var(--accent);
        box-shadow: 0 0 0 1px rgba(110, 231, 183, 0.4);
        cursor: default;
      }

      .section-title {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
      }

      .progress {
        height: 6px;
        background: rgba(255, 255, 255, 0.06);
        border-radius: 999px;
        overflow: hidden;
        margin: 8px 0;
      }

      .progress > span {
        display: block;
        height: 100%;
        background: linear-gradient(90deg, var(--accent), var(--accent-strong));
      }

      .fields {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 10px;
      }

      label {
        font-size: 13px;
        color: var(--text);
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      input.field-input {
        width: 100%;
        padding: 10px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.02);
        color: var(--text);
        box-sizing: border-box;
      }

      input.field-input:focus {
        outline: 2px solid var(--accent);
      }

      .helper {
        color: var(--muted);
        font-size: 12px;
      }

      .actions {
        margin-top: 16px;
        display: flex;
        gap: 8px;
      }

      button.action-btn {
        background: var(--accent);
        color: #0b1223;
        border: none;
        border-radius: 10px;
        padding: 10px 14px;
        font-weight: 700;
        cursor: pointer;
      }

      button.secondary {
        background: transparent;
        color: var(--muted);
        border: 1px solid var(--border);
      }

      .empty {
        text-align: center;
        padding: 32px;
        color: var(--muted);
      }
    </style>
  </head>
  <body>
    <div class="panel">
      <div style="display:flex; justify-content:space-between; align-items:flex-start;">
        <h1>Business onboarding</h1>
        <button id="logoutBtn" class="link-btn" style="display:none">Sign Out</button>
      </div>
      
      <!-- AUTH VIEW -->
      <div id="authView">
        <div class="subtitle">Sign in to sync your profile with the Portal.</div>
        <div class="auth-container">
            <input type="email" id="email" class="auth-input" placeholder="Email address" />
            <input type="password" id="password" class="auth-input" placeholder="Password" />
            
            <button id="signInBtn" class="auth-btn">Sign In</button>
            <div class="divider">or</div>
            <button id="signUpBtn" class="auth-btn secondary">Create Account</button>
            <div class="divider">or</div>
            <button id="googleBtn" class="auth-btn google-btn">
               <span style="font-weight:bold; color:#4285F4">G</span> Sign in with Google
            </button>
            
            <div id="authError" class="error-msg"></div>
        </div>
      </div>

      <!-- APP VIEW -->
      <div id="appView" style="display:none">
        <div class="subtitle">Drive the same flow the Portal uses to collect business profile details.</div>
        <div class="status-row" id="statusRow"></div>
        <div class="sections" id="sections"></div>
        <div class="actions">
            <button id="refresh" class="action-btn">Reload profile</button>
            <button class="secondary action-btn" id="reset">Reset progress</button>
        </div>
        <div class="empty" id="emptyState" hidden>No sections are configured yet.</div>
      </div>
    </div>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDGIywlZJ4bPn84s5FYNx6v27-tO3f3SWA",
        authDomain: "gen-lang-client-0255740881.firebaseapp.com",
        projectId: "gen-lang-client-0255740881",
        storageBucket: "gen-lang-client-0255740881.firebasestorage.app",
        messagingSenderId: "504416778150",
        appId: "1:504416778150:web:4ee874644b209c51d58167"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      
      const openai = window.openai;
      let state = { ...(openai.widgetState || {}) };
      let currentUser = null;

      function showError(msg) {
        document.getElementById("authError").textContent = msg;
        setTimeout(() => document.getElementById("authError").textContent = "", 5000);
      }

      // AUTH HANDLERS
      document.getElementById("signInBtn").onclick = async () => {
         const email = document.getElementById("email").value;
         const pass = document.getElementById("password").value;
         if(!email || !pass) return showError("Please enter email and password");
         try {
             await signInWithEmailAndPassword(auth, email, pass);
         } catch(e) {
             showError(e.message);
         }
      };

      document.getElementById("signUpBtn").onclick = async () => {
         const email = document.getElementById("email").value;
         const pass = document.getElementById("password").value;
         if(!email || !pass) return showError("Please enter email and password");
         try {
             await createUserWithEmailAndPassword(auth, email, pass);
         } catch(e) {
             showError(e.message);
         }
      };

      document.getElementById("googleBtn").onclick = async () => {
         try {
             const provider = new GoogleAuthProvider();
             await signInWithPopup(auth, provider);
         } catch(e) {
             showError(e.message);
         }
      };

      document.getElementById("logoutBtn").onclick = () => {
         signOut(auth);
      };

      // UI STATE MANAGEMENT
      onAuthStateChanged(auth, (user) => {
          if (user) {
              currentUser = user;
              document.getElementById("authView").style.display = "none";
              document.getElementById("logoutBtn").style.display = "block";
              document.getElementById("appView").style.display = "block";
              
              state.accountId = user.uid;
              initData();
          } else {
              currentUser = null;
              document.getElementById("authView").style.display = "block";
              document.getElementById("logoutBtn").style.display = "none";
              document.getElementById("appView").style.display = "none";
              state.accountId = null;
              renderSections(null); // Clear sections if logged out
              renderStatus(null); // Clear status if logged out
          }
      });

      function formatPercent(value) {
        return `${Math.min(100, Math.max(0, Math.round(value ?? 0)))}%`;
      }

      function renderStatus(data) {
        const container = document.getElementById("statusRow");
        if (!data) {
            container.innerHTML = '';
            return;
        }
        const completion = formatPercent(data?.completionPercent);
        const required = formatPercent(data?.requiredCompletionPercent);
        const pill = document.createElement("span");
        pill.className = "pill";
        pill.textContent = data?.onboardingStatus === "complete" ? "Complete" : "In progress";
        const status = document.createElement("div");
        status.textContent = `Required fields: ${required}`;
        const next = document.createElement("div");
        next.textContent = data?.nextSection ? `Next: ${data.nextSection.title}` : "All sections reviewed.";
        container.replaceChildren(pill, status, next);
      }

      function resolveAccountId(metadata) {
        if (currentUser) return currentUser.uid;

        const candidate =
          state.accountId ||
          metadata?.accountId ||
          openai.toolResponseMetadata?.accountId ||
          openai.toolOutput?.accountId;

        return candidate && String(candidate).trim().length > 0 ? String(candidate) : null;
      }

      function resolveMetadata() {
        return (
          openai.toolResponseMetadata ||
          openai.toolOutput?.toolResponseMetadata ||
          openai.toolOutput?._meta ||
          state.metadata
        );
      }

      function saveWidgetState(partial) {
        const next = { ...state, ...partial };
        state = next;
        openai.setWidgetState(next);
      }

      // Map of current input elements to keep track of their values and prevent re-render issues
      const currentInputValues = new Map();

      function onInputChange(event) {
        const input = event.target;
        const sectionKey = input.dataset.section;
        const fieldKey = input.dataset.field;
        const value = input.value;

        if (!sectionKey || !fieldKey || !currentUser) return;

        // Immediately update local UI state (and the hidden metadata if active)
        // This prevents text from disappearing.
        currentInputValues.set(`${sectionKey}-${fieldKey}`, value);
        
        // Find the specific field in the state.metadata and update its value
        const section = state.metadata?.sections?.find(s => s.key === sectionKey);
        const field = section?.fields?.find(f => f.key === fieldKey);
        if (field) {
            field.value = value; // Update the internal data model
            renderStatus(openai.toolOutput || state.metadata); // Re-render status bar if needed
            // No full renderSections call here!
        }

        // Asynchronously call the tool to persist to the backend (Firestore)
        openai
          .callTool("update_business_profile_field", {
            accountId: currentUser.uid,
            sectionKey: sectionKey,
            fieldKey: fieldKey,
            value: value,
          })
          .catch((error) => console.error("Failed to save field", error));
      }

      function renderSections(meta) {
        const container = document.getElementById("sections");
        const empty = document.getElementById("emptyState");

        if (!meta?.sections?.length) {
          container.innerHTML = "";
          empty.hidden = false;
          openai.notifyIntrinsicHeight?.();
          return;
        }

        empty.hidden = true;
        const activeSection = state.activeSection || meta.sections[0].key;
        
        // Store current focus/selection
        const activeElement = document.activeElement;
        const focusedInputId = activeElement?.dataset?.section && activeElement?.dataset?.field 
                               ? `${activeElement.dataset.section}-${activeElement.dataset.field}` 
                               : null;
        const selectionStart = (activeElement as HTMLInputElement)?.selectionStart;
        const selectionEnd = (activeElement as HTMLInputElement)?.selectionEnd;

        const cards = meta.sections.map((section) => {
          const wrapper = document.createElement("div");
          wrapper.className = "section-card";
          wrapper.dataset.active = String(section.key === activeSection);
          
          wrapper.onclick = (e) => {
            const tag = (e.target as HTMLElement).tagName;
            if (tag === 'INPUT' || tag === 'LABEL' || (e.target as HTMLElement).closest('.fields')) return;

            if (state.activeSection !== section.key) {
                saveWidgetState({ activeSection: section.key });
                renderSections(meta); // Re-render when section changes
            }
          };

          const header = document.createElement("div");
          header.className = "section-title";
          header.innerHTML = `<span>${section.title}</span><span class="pill">${section.fields.filter((f) => f.value).length}/${section.fields.length}</span>`;

          const progress = document.createElement("div");
          progress.className = "progress";
          const percent = Math.round((section.fields.filter((f) => f.value).length / section.fields.length) * 100);
          progress.innerHTML = `<span style="width:${percent}%"></span>`;

          const fields = document.createElement("div");
          fields.className = "fields";
          if (section.key === activeSection) {
            section.fields.forEach((field) => {
              const label = document.createElement("label");
              label.innerHTML = `${field.label}${field.required ? " *" : ""}`;
              const input = document.createElement("input");
              input.className = "field-input";
              input.dataset.section = section.key;
              input.dataset.field = field.key;
              
              // Use value from metadata, but if actively typing, use the cached value
              const inputId = `${section.key}-${field.key}`;
              input.value = currentInputValues.has(inputId) 
                            ? currentInputValues.get(inputId) 
                            : (field.value ?? "");

              input.placeholder = field.helper ?? "";
              
              // Only add event listener once
              input.addEventListener("input", onInputChange);
              input.addEventListener("click", (e) => e.stopPropagation());

              label.appendChild(input);
              if (field.helper) {
                const helper = document.createElement("div");
                helper.className = "helper";
                helper.textContent = field.helper;
                label.appendChild(helper);
              }
              fields.appendChild(label);
            });
          } else {
            const hint = document.createElement("div");
            hint.className = "helper";
            hint.textContent = "Select to edit fields.";
            fields.appendChild(hint);
          }

          wrapper.appendChild(header);
          wrapper.appendChild(progress);
          wrapper.appendChild(fields);
          return wrapper;
        });

        container.replaceChildren(...cards);

        // Restore focus/selection after re-render if applicable
        if (focusedInputId) {
            const newActiveInput = document.querySelector(`[data-section="${focusedInputId.split('-')[0]}"][data-field="${focusedInputId.split('-')[1]}"]`) as HTMLInputElement;
            if (newActiveInput) {
                newActiveInput.focus();
                if (selectionStart !== null && selectionEnd !== null) {
                    newActiveInput.setSelectionRange(selectionStart, selectionEnd);
                }
            }
        }
        openai.notifyIntrinsicHeight?.();
      }

      function wireButtons() {
        const refresh = document.getElementById("refresh");
        refresh.onclick = () => {
          if (!currentUser) return;
          // Clear current input values before a full refresh
          currentInputValues.clear(); 
          initData();
        };

        const reset = document.getElementById("reset");
        reset.onclick = () => {
          if (!currentUser) return;
          const accountId = currentUser.uid;
          
          openai.callTool("reset_business_profile", { accountId })
            .then((response) => {
              const metadata = response?.toolResponseMetadata || response?._meta || resolveMetadata();
              if (metadata?.sections?.length) {
                // Clear current input values after a reset
                currentInputValues.clear(); 
                saveWidgetState({ metadata, accountId });
                renderStatus(response?.structuredContent || openai.toolOutput);
                renderSections(metadata);
              }
            })
            .catch((error) => console.error("Failed to reset profile", error));
        };
      }

      async function initData() {
        // This function is called when a user logs in or clicks refresh
        renderStatus(openai.toolOutput || state.metadata); // Initial status rendering
        const metadata = resolveMetadata();
        const accountId = resolveAccountId(metadata); // Should be currentUser.uid now
        
        saveWidgetState({ accountId, metadata });
        
        if (metadata?.sections?.length) {
          renderSections(metadata);
        } else {
          try {
            const payload = {};
            if (accountId) payload.accountId = accountId;
            
            const response = await openai.callTool("load_business_profile", { ...payload, restart: false });
            const metaFromResponse = response?.toolResponseMetadata || response?._meta || metadata;
            
            if (metaFromResponse?.sections?.length) {
              saveWidgetState({ metadata: metaFromResponse, accountId: resolveAccountId(metaFromResponse) });
              renderStatus(response?.structuredContent || openai.toolOutput);
              renderSections(metaFromResponse);
            }
          } catch (error) {
            console.error("Failed to bootstrap onboarding", error);
            // Even if bootstrap fails, we might still have a user, show auth view
            if (!currentUser) {
                document.getElementById("authView").style.display = "block";
                document.getElementById("appView").style.display = "none";
            }
          }
        }
        wireButtons();
      }

      // Initial setup when the widget loads
      // The onAuthStateChanged listener will handle calling initData() if logged in
      // Otherwise, the auth view will remain visible.
      // Explicitly show authView initially, onAuthStateChanged will hide it if logged in.
      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById("authView").style.display = "block";
        document.getElementById("appView").style.display = "none";
        // The onAuthStateChanged listener will take over from here
      });
    </script>
  </body>
</html>
